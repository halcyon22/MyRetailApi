# MyRetailApi
Target Recruiting case study.

The MyRetailApi application uses Java 1.8, Spring Boot 2, and a standalone MongoDB 3.6 instance.

The web application is packaged as a public Docker image at `docker.io/mpartridge/myretailapi`, and `docker-compose.yml` can be used from the project root directory to startup the webapp and associated MongoDB instance. `docker-compose.yml` seeds MongoDB with data from `mongodb_init/seed.js`, and a Docker volume is used to persist data between restarts.

By default the web application connects to a MongoDB instance on the default port on localhost, so for deployment this is modified to connect to the MongoDB container by a Spring profile used in `docker-compose.yml`.

```
docker-compose up -d
```

## Usage
The API can be accessed at http://ec2-18-218-192-245.us-east-2.compute.amazonaws.com:8080

Example:

```
curl -i --user user:myretailcasestudy -XGET http://ec2-18-218-192-245.us-east-2.compute.amazonaws.com:8080/products/13860428
```

### Updating Price
CSRF protection is enabled, and a `X-CSRF-TOKEN` header is sent in all `200 OK` responses. The token associated with the current session is required for `PUT` requests.

1. Execute a `GET` request to get a CSRF token and initiate a session and store the cookie in cookies.txt:

```
curl -i \
    --cookie-jar cookies.txt \
    --user user:myretailcasestudy \
    -XGET http://ec2-18-218-192-245.us-east-2.compute.amazonaws.com:8080/products/13860428
```
2. Execute another `GET` request in the same session and store the CSRF token for the session in headers.txt:

```
curl -i \
    --cookie cookies.txt \
    --dump-header headers.txt \
    --user user:myretailcasestudy \
    -XGET http://ec2-18-218-192-245.us-east-2.compute.amazonaws.com:8080/products/13860428
```
3. Execute the `PUT` request with the CSRF token:

```
curl -i \
    --cookie cookies.txt \
    --header "$(grep X-CSRF-TOKEN: headers.txt)" \
    --header "Content-Type: application/json" \
    --user user:myretailcasestudy \
    -XPUT http://ec2-18-218-192-245.us-east-2.compute.amazonaws.com:8080/products/13860428 \
    -d'{"id":13860428,"name":"The Big Lebowski (Blu-ray)","current_price":{"value":4.99,"currency_code":"USD"}}'
```

## Running Outside of Docker Compose
The following command can be used to startup a MongoDB Docker container initialized with seed data, which can be used for integration tests and local development.

```
docker run --name mongodb -d \
    -p=27017:27017 \
    -e MONGO_INITDB_DATABASE=myretail \
    --mount source=mongodata,target=/data/db \
    --mount type=bind,source="$(pwd)"/mongodb_init,target=/docker-entrypoint-initdb.d \
    mongo:3.6
```

## Improvements

### Get Repository Integration Tests Running Without a Standalone MongoDB Instance
I use `@SpringBootTest` on `PriceRepositoryTest` in order to get a `PriceRepository` with generated CRUD methods, but this causes Spring Boot to use the default MongoDB connection parameters. `@DataMongoTest` starts an in-memory MongoDB instance, but that then `PriceRepository` CRUD methods aren't generated by Spring Data. The following article may help create the in-memory MongoDB instance during testing and configure Spring Boot to use it:

- https://dzone.com/articles/spring-boot-with-embedded-mongodb 

### Replace existing Price storage
This is my first time designing a document datasource, and right now it's implemented in a row-centric fashion. Putting all price info inside a single document per product would make more sense, but an even more efficient solution might be for each document to store product prices in a single currency, because most of the time you would probably be looking for prices for a specific currency, so the document could be indexed on `productId` and `currency_code`.

```
{
	"productId": 1,
	"currency_code": "USD",
	"prices": [{
		"start_date": "1900-01-01",
		"price": 15.99
	},{
		"start_date": "2018-01-01",
		"price": 12.99
	}]
}
```

### Abstract Product Details datasource
1. Create a `ProductDetailsApiClient` interface.
1. Make `RedSkyApiClient` implement it.
1. Configure API client implementation by Spring profile.

### Add HATEOAS Support
- https://spring.io/guides/gs/rest-hateoas/
